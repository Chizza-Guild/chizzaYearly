{% extends "base.html" %}

{% block title %}{{ year }} Wrapped - Chizza Guild{% endblock %}

{% block content %}
<div class="wrapped-container" id="wrapped-container">
    <!-- Progress indicator -->
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>

    <!-- Navigation hint -->
    <div class="nav-hint">
        <span class="nav-arrow">←</span>
        <span class="nav-text">Use arrow keys or swipe</span>
        <span class="nav-arrow">→</span>
    </div>

    <!-- Story pages -->
    <div class="story-wrapper" id="story-wrapper">

        <!-- Page 1: Welcome -->
        <div class="story-page active" data-page="1">
            <div class="story-content">
                <h1 class="story-title animate-in">{{ summary.guild_name }}</h1>
                <h2 class="story-subtitle animate-in delay-1">{{ year }} Wrapped</h2>
                <p class="story-text animate-in delay-2">Your year in review</p>
            </div>
        </div>

        <!-- Page 2: Quest Champions -->
        <div class="story-page" data-page="2">
            <div class="data-source-badge">Hypixel</div>
            <div class="story-content">
                <h2 class="story-heading">Quest Champions</h2>
                <p class="story-subheading">Most Guild Quests Completed</p>
                <div class="leaderboard">
                    {% for member in summary.top_xp_earners[:5] %}
                    <div class="leaderboard-item">
                        <span class="rank">#{{ loop.index }}</span>
                        <span class="name">{{ member.username }}</span>
                        <span class="stat">{{ "{:,}".format(member.quest_participation) }} quests</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Page 3: Top Messengers (only if Discord data available) -->
        {% if summary.total_messages > 0 %}
        <div class="story-page" data-page="3">
            <div class="data-source-badge">Discord</div>
            <div class="story-content">
                <h2 class="story-heading">Chattiest Members</h2>
                <p class="story-subheading">Most Messages Sent</p>
                <div class="leaderboard">
                    {% for member in summary.top_messengers[:5] %}
                    <div class="leaderboard-item">
                        <span class="rank">#{{ loop.index }}</span>
                        <span class="name">{{ member.username }}</span>
                        <span class="stat">{{ "{:,}".format(member.discord_messages) }} messages</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Page 4: New Members -->
        <div class="story-page" data-page="4">
            <div class="data-source-badge">Hypixel</div>
            <div class="story-content">
                <h2 class="story-heading">Fresh Faces</h2>
                <p class="story-subheading">{{ summary.new_members_count }} members joined in {{ year }}</p>
                <div class="member-grid">
                    {% for member in summary.new_members[:9] %}
                    <div class="member-card">
                        <div class="member-name">{{ member.username }}</div>
                        <div class="member-joined">Joined {{ member.joined_date }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Page 5: Guild Veterancy -->
        <div class="story-page" data-page="5">
            <div class="data-source-badge">Hypixel</div>
            <div class="story-content">
                <h2 class="story-heading">Guild Veterancy</h2>
                <p class="story-subheading">The Original Members</p>
                <div class="member-grid">
                    {% for member in summary.guild_veterans[:12] %}
                    <div class="member-card">
                        <div class="member-name">{{ member.username }}</div>
                        <div class="member-joined">Joined {{ member.joined_date }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Page 6: Most Pinged (only if Discord data available) -->
        {% if summary.total_messages > 0 %}
        <div class="story-page" data-page="6">
            <div class="data-source-badge">Discord</div>
            <div class="story-content">
                <h2 class="story-heading">Most Popular</h2>
                <p class="story-subheading">Most Mentioned Members</p>
                <div class="leaderboard">
                    {% for member in summary.most_pinged[:5] %}
                    <div class="leaderboard-item">
                        <span class="rank">#{{ loop.index }}</span>
                        <span class="name">{{ member.username }}</span>
                        <span class="stat">{{ "{:,}".format(member.times_pinged) }} pings</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Page 7: Fun Facts -->
        <div class="story-page" data-page="7">
            <div class="data-source-badge">Hypixel & Discord</div>
            <div class="story-content">
                <h2 class="story-heading">By The Numbers</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value count-up" data-target="{{ summary.new_members_count }}">0</div>
                        <div class="stat-label">New Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value count-up" data-target="{{ summary.total_guild_xp }}">0</div>
                        <div class="stat-label">Total Guild XP</div>
                    </div>
                    {% if summary.total_messages > 0 %}
                    <div class="stat-card">
                        <div class="stat-value count-up" data-target="{{ summary.total_messages }}">0</div>
                        <div class="stat-label">Messages Sent</div>
                    </div>
                    {% endif %}
                </div>
                {% if summary.most_active_day %}
                <p class="fun-fact">Most active day: {{ summary.most_active_day }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Page 8: Wordle Winners (only if Wordle data available) -->
        {% if summary.total_wordle_games > 0 %}
        <div class="story-page" data-page="8">
            <div class="data-source-badge">Wordle</div>
            <div class="story-content">
                <h2 class="story-heading">Wordle Masters</h2>
                <p class="story-subheading">Top 5 Winners</p>
                <div class="leaderboard">
                    {% for player in summary.wordle_top_winners[:5] %}
                    <div class="leaderboard-item">
                        <span class="rank">#{{ loop.index }}</span>
                        <span class="name">{{ player.username }}</span>
                        <span class="stat">{{ player.wins }} wins | {{ player.win_rate }}% | Avg: {{ player.average_guesses }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Page 9: Wordle Failures (only if Wordle data available) -->
        <div class="story-page" data-page="9">
            <div class="data-source-badge">Wordle</div>
            <div class="story-content">
                <h2 class="story-heading">Wordle Struggles</h2>
                <p class="story-subheading">Most Failures</p>
                <div class="leaderboard">
                    {% for player in summary.wordle_top_failures[:5] %}
                    <div class="leaderboard-item">
                        <span class="rank">#{{ loop.index }}</span>
                        <span class="name">{{ player.username }}</span>
                        <span class="stat">{{ player.losses }} failures ({{player.total_games }} games)</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Custom Pages from JSON -->
        {% if summary.custom_pages %}
            {% set base_pages = 7 %}
            {% if summary.total_messages > 0 %}{% set base_pages = base_pages + 2 %}{% endif %}
            {% if summary.total_wordle_games > 0 %}{% set base_pages = base_pages + 2 %}{% endif %}

            {% for custom_page in summary.custom_pages %}
                {% set page_num = base_pages + loop.index %}

                <div class="story-page custom-page" data-page="{{ page_num }}"
                     {% if custom_page.background_gradient %}
                     style="background: {{ custom_page.background_gradient }};"
                     {% endif %}>
                    {% if custom_page.data_source %}
                    <div class="data-source-badge">{{ custom_page.data_source }}</div>
                    {% endif %}
                    <div class="story-content">

                        {% if custom_page.page_type == "leaderboard" %}
                            <h2 class="story-heading">{{ custom_page.title }}</h2>
                            {% if custom_page.subtitle %}
                            <p class="story-subheading">{{ custom_page.subtitle }}</p>
                            {% endif %}
                            <div class="leaderboard">
                                {% for item in custom_page.items %}
                                <div class="leaderboard-item">
                                    <span class="rank">#{{ item.rank }}</span>
                                    <span class="name">{{ item.name }}</span>
                                    <span class="stat">{{ item.stat }}</span>
                                </div>
                                {% endfor %}
                            </div>

                        {% elif custom_page.page_type == "grid" %}
                            <h2 class="story-heading">{{ custom_page.title }}</h2>
                            {% if custom_page.subtitle %}
                            <p class="story-subheading">{{ custom_page.subtitle }}</p>
                            {% endif %}
                            <div class="member-grid">
                                {% for item in custom_page.items %}
                                <div class="member-card">
                                    <div class="member-name">{{ item.name }}</div>
                                    <div class="member-joined">{{ item.detail }}</div>
                                </div>
                                {% endfor %}
                            </div>

                        {% elif custom_page.page_type == "stats" %}
                            <h2 class="story-heading">{{ custom_page.title }}</h2>
                            {% if custom_page.subtitle %}
                            <p class="story-subheading">{{ custom_page.subtitle }}</p>
                            {% endif %}
                            <div class="stats-grid">
                                {% for stat in custom_page.stats %}
                                <div class="stat-card">
                                    <div class="stat-value count-up" data-target="{{ stat.value }}">0</div>
                                    <div class="stat-label">{{ stat.label }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if custom_page.fun_fact %}
                            <p class="fun-fact">{{ custom_page.fun_fact }}</p>
                            {% endif %}

                        {% elif custom_page.page_type == "text" %}
                            <h1 class="story-title animate-in">{{ custom_page.title }}</h1>
                            {% if custom_page.subtitle %}
                            <h2 class="story-subtitle animate-in delay-1">{{ custom_page.subtitle }}</h2>
                            {% endif %}
                            <p class="story-text animate-in delay-2">{{ custom_page.body }}</p>

                        {% endif %}

                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Page 10: Thank You -->
        <div class="story-page" data-page="10">
            <div class="story-content">
                <h1 class="story-title animate-in">Thank You</h1>
                <p class="story-text animate-in delay-1">For an amazing {{ year }}</p>
                <p class="story-text animate-in delay-2">See you next year!</p>
                <a href="/" class="back-button animate-in delay-3">← Back to Home</a>
            </div>
        </div>

    </div>

    <!-- Navigation buttons -->
    <button class="nav-button nav-prev" id="nav-prev" aria-label="Previous page">
        <span>←</span>
    </button>
    <button class="nav-button nav-next" id="nav-next" aria-label="Next page">
        <span>→</span>
    </button>
</div>

<script>
    // Initialize wrapped with total pages
    if (typeof initializeWrapped === 'function') {
        // Calculate total pages dynamically based on conditional content
        let totalPages = 7;  // Base pages: Welcome, Quest Champions, New Members, Guild Veterancy, By The Numbers, Thank You
        {% if summary.total_messages > 0 %}
        totalPages += 2;  // Add Chattiest Members and Most Popular
        {% endif %}
        {% if summary.total_wordle_games > 0 %}
        totalPages += 2;  // Add Wordle Masters and Wordle Struggles
        {% endif %}
        {% if summary.custom_pages %}
        totalPages += {{ summary.custom_pages|length }};  // Add custom pages
        {% endif %}
        initializeWrapped(totalPages);
    }
</script>
{% endblock %}
